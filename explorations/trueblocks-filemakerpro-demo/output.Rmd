---
params:
  filepath: "./data/output.csv"
  address: "0x1fd169A4f5c59ACf79d0Fd5d91D1201EF1Bce9f1"
  name: "MolochDAO"
always_allow_html: yes
output:
  html_document:
    theme: sandstone
    df_print: paged
    includes:
    code_folding: "hide"
    css: "style.css"
---

<div class="header">
<img src="trueblocks-logo.png" class="logo"/>
<h1>Autogenerated R output</h1>
<ul>
<li><strong>Address:</strong> `r params$address`</li>
<li><strong>Name:</strong> `r params$name`</li>
<li><strong>Date:</strong> `r Sys.Date()`</li>
</ul>
</div>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(scales)
p.address <- tolower(params$address)
tf.scale <- c(`FALSE` = "#000000", `TRUE` = "#CC0000")
```

```{r message=FALSE, echo=FALSE, warning=FALSE}
data.set <- read_csv(params$filepath) %>%
  mutate(Date = as.POSIXct(Date, format="%m/%d/%Y %H:%M:%S")) %>%
#  mutate(FunctionName = ifelse(is.na(FunctionName), "NA", FunctionName)) %>%
  mutate(FromName = ifelse(is.na(FromName), From, FromName)) %>%
  mutate(isError = isError == 1) %>%
  return()

theme_set(theme_minimal(base_size=12))
```


# Money in/out

<div class="blue">
This section deals with the ether coming in and out of the account, as well as a bit about dollars.
</div>

## ETH deposit (ETH in) timeline

```{r message=FALSE, fig.height=4}
data.set %>%
  filter(To == p.address) %>%
  ggplot(aes(x=BlockNumber, y=DollarsThen, size=EtherValue, color=isError)) +
  scale_color_manual(values = tf.scale) +
  geom_jitter()
```

## Value transferred in by account

```{r message=FALSE}
data.set %>%
  filter(To == p.address & !isError) %>%
  group_by(FromName) %>%
  summarize(n = n(), sum.eth.value = sum(EtherValue), sum.dollars.then = sum(DollarsThen)) %>%
  arrange(desc(sum.eth.value)) %>%
  mutate(sum.eth.value = round(sum.eth.value, 3), sum.dollars.then = round(sum.dollars.then, 3))
```

## Chart of ETH in/out
```{r message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=4, fig.cap="This chart is a work in progress. In the case of smart contracts, it is common for 'ETH out' values to be contained in traces. We still have to parse these traces to include them in this chart."}
data.set %>%
  mutate(Type = ifelse(To == p.address, "In", ifelse(From == p.address, "From", "Other"))) %>%
  filter(Type %in% c("In", "Out") & !isError) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(EtherValue = ifelse(Type == "Out", -EtherValue, EtherValue)) %>%
  group_by(Type, Date) %>%
  summarize(val = sum(EtherValue)) %>%
  mutate(cumval = cumsum(val)) %>%
  ggplot(aes(x=Date, y=cumval, color=Type)) +
  geom_line() +
  labs(title="Ether In/Out", y="Cumulative Ether In/Out")
```

# Function calls

<div class="blue">
This section provides insight into what functions were called when and by whom.
</div>

## Function calls on address `r p.address`

```{r message=FALSE, fig.align='center', fig.height=12}
data.set %>%
  filter(To == p.address) %>%
  ggplot(aes(x=BlockNumber, fill=isError)) +
  geom_histogram() +
  scale_x_continuous(labels = comma) + 
  facet_wrap(facets = "FunctionName", ncol = 1, scales = "free_y") +
  scale_fill_manual(values = tf.scale) +
  theme(panel.spacing = unit(2, "lines"))
```

## Users in order of appearance count

```{r}
data.set %>%
  filter(To == p.address) %>%
  mutate(isError = factor(isError, levels = c(FALSE, TRUE))) %>%
  group_by(FromName, isError) %>%
  summarize(count = n()) %>%
  spread(isError, count, drop = FALSE) %>%
  rename(error = `TRUE`, success = `FALSE`) %>%
  mutate_at(c("error", "success"), function(x) {return(ifelse(is.na(x), 0, x))}) %>%
  mutate(total = error + success) %>%
  arrange(desc(total))
```

##  Activity plot for top 10 most active users (users ranked by appearance count)

```{r message=FALSE, echo=FALSE, warning=FALSE}
top10 <- data.set %>%
  filter(To == p.address) %>%
  group_by(FromName) %>%
  summarize(count = n()) %>%
  top_n(10, count) %>%
  filter(row_number() <= 10) %>%
  select(FromName) %>%
  unlist() %>%
  unname()
```

```{r message=FALSE, fig.align='center', fig.width=10, fig.height=18}
data.set %>%
  filter(To == p.address) %>%
  filter(FromName %in% top10) %>%
  ggplot(aes(x=Date, y=FunctionName, color=isError)) +
  scale_color_manual(values = tf.scale) +
  geom_jitter(width=.2, height=.2) +
  facet_wrap(facets = 'FromName', ncol=1) +
  theme(panel.spacing = unit(2, "lines"))
```


# Categories

<div class="blue">
This section displays data according to the categorization done by the TrueBlocks explorer application.
</div>

## Appearances by category

```{r message=FALSE, fig.align='center', warning=FALSE}
data.set %>%
  filter(To == p.address) %>%
  ggplot(aes(x=Date, y=Category, color=isError)) +
  geom_jitter(width=0, height=.2) +
  scale_color_manual(values = tf.scale)
```

```{r}
params
```